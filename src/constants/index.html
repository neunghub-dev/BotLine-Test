if (round) {
  const data = JSON.stringify(round);
  const roundItem = JSON.parse(data);
  delete roundItem.id;
  delete roundItem.round;
  delete roundItem.isOpen;
  delete roundItem.isClose;
  delete roundItem.openRoundAt;
  delete roundItem.type;
  delete roundItem.groupId;
  delete roundItem.sumTotal;
  delete roundItem.difference;
  delete roundItem.createdAt;
  delete roundItem.updatedAt;
  // const result = roundItem.keys(obj).map((key) => [key, obj[key]]);
  console.log(roundItem);
  const convertedArray = Object.entries(roundItem).map(
    ([key, value], index) => ({
      name: `k${index}`,
      nameTxt:
        index === 0
          ? `à¸‚à¸²à¹€à¸ˆà¹‰à¸² = ${convertPokTxt(value)}`
          : `à¸‚à¸²${index} = ${convertPokTxt(value)}`,
      number: value,
      convertNumber: convertPokNumber(value),
      textNumber: convertPokTxt(value),
    })
  );
  const transformedData = convertedArray.map((item) => ({
    name: item.name,
    number: item.number,
    convertNumber: item.convertNumber,
    isLeader: item.name === "k0",
    status: "",
    isPok: checkPok(item),
  }));

  for (const item of transformedData) {
    if (!item.isLeader) {
      if (
        parseFloat(item.number.slice(1)) >
        parseFloat(transformedData[0].number.slice(1))
      ) {
        item.status = "winner";
      } else if (
        parseFloat(item.number.slice(1)) ===
        parseFloat(transformedData[0].number.slice(1))
      ) {
        item.status = "draw";
      } else {
        item.status = "loser";
      }
    } else {
      continue;
    }
  }
  const detail = await roundService.getAllRoundDetailByRoundId(
    round.id
  );
  const json = JSON.stringify(detail);
  const detailItem = JSON.parse(json);
  // console.log(detailItem);
  const result = await convertArray(detailItem, groupId, userId);
  console.log(result);
  transformedData.forEach((e) => {
    result.forEach((item) => {
      item.play.forEach((play) => {
        if (e.name === play.name) {
          if (e.status === "winner") {
            if (e.isPok === true) {
              if (play.isDeduction) {
                console.log("isDeduction 1");
                play.balance = play.unit * 2 * 2;
                item.total += play.balance;
                play.net += play.unit * 2;
              } else {
                console.log("isDeduction 2");
                play.balance = play.unit * 2;
                item.total += play.balance;
                play.net += play.unit;
              }
            } else {
              if (play.isDeduction) {
                console.log("isDeduction 3");
                play.balance = play.unit + play.unit * 2;
                item.total += play.balance;
                play.net += play.unit;
              } else {
                console.log("isDeduction 4");
                play.balance = play.unit * 2;
                item.total += play.balance;
                play.net += play.unit;
              }
            }
          } else if (e.status === "loser") {
            if (transformedData[0].isPok === true) {
              if (play.isDeduction) {
                play.broken += play.unit * 2;
                play.balance = 0;
                item.total += play.balance;
                item.totalBroken += play.broken;
              } else {
                play.broken += play.unit * 1;
                play.balance = 0;
                item.total += play.balance;
                item.totalBroken += play.broken;
              }
            } else {
              if (play.isDeduction) {
                play.broken += play.unit * 1;
                play.balance = play.unit * 1;
                item.total += play.balance;
                item.totalBroken += play.broken;
              } else {
                play.balance = 0;
                play.broken += 0;
                item.total += play.balance;
                item.totalBroken += play.broken;
              }
            }
          } else {
            if (play.isDeduction) {
              play.balance = play.unit * 2;
              item.total += play.balance;
            } else {
              play.balance = play.unit * 1;
              item.total += play.balance;
            }
          }
        }
      });
    });
  });
  result.forEach((obj) => {
    obj.totalBalance = obj.play.reduce(
      (sum, playItem) => sum + playItem.balance,
      0
    );
  });
  result.forEach((obj) => {
    obj.totalNet = obj.play.reduce(
      (sum, playItem) => sum + playItem.net,
      0
    );
  });
  console.log(result);

  let sumTotal = 0;
  let sumBroken = 0;
  let sumUnit = 0;
  let diff = 0;
  const filteredPlayArray = result.map((item) => ({
    ...item,
    play: item.play.filter((playItem) => playItem.unit !== 0),
  }));

  filteredPlayArray.forEach((item) => {
    item.play.forEach((play) => {
      if (play.isDeduction) {
        sumUnit += play.unit * 2;
      } else {
        sumUnit += play.unit;
      }
    });
    sumTotal += item.total;
    sumBroken += item.totalBroken;
  });

  if (result.length !== 0) {
    for (const item of result) {
      const user = await usersService.getCreadit(item.id);
      const newCredit = user.credit + item.total;
      await usersService.addCredit(newCredit, item.id);
    }
    const close = await roundService.closeStatus(round.id, groupId);
    const total = await roundService.updateTotal(
      round.id,
      sumUnit,
      sumBroken
    );
    if (close && total) {
      messageTotal = "";
      BotEvent.replyMessage(replyToken, {
        type: "text",
        text: "à¸­à¸±à¸žà¹€à¸”à¸—à¸¢à¸­à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ ðŸŽŠ",
      });
    }
  } else {
    BotEvent.replyMessage(replyToken, {
      type: "text",
      text: "à¸­à¸±à¸žà¹€à¸”à¸—à¸¢à¸­à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ ðŸŽŠ",
    });
    await roundService.closeStatus(round.id, groupId);

    messageTotal = "";
  }
} else {
  await BotEvent.replyMessage(
    replyToken,
    BotEvent.replyMessage(replyToken, {
      type: "image",
      originalContentUrl:
        "https://hook.nuenghub-soft.online/img/w13.png",
      previewImageUrl:
        "https://hook.nuenghub-soft.online/img/w13.png",
    })
  );
  return;
}